"use strict";angular.module("sbAdminApp").controller("mainCtrl",["$scope","$position","$http",function($scope,$position,$http){function loadShortCodes(){$http.get("api/unprocessedcodes/"+$scope.skip.code).then(function(response){$scope.shortCodeList=response.data.data.newShortCode,$scope.length=response.data.data.newShortCodeLength;var code=$scope.shortCodeList[0];$scope.loadsms(code)},function(response){$scope.alerts=[{msg:response.data.userMessage||"Server error! Are you connected to the internet?.",type:"error"}]})}function getShortcodes(){$scope.count={processing:[],"new":[],blacklist:[]},$scope.codeCount=[],$http.get("api/count/shortcode").then(function(response){$scope.codeCount=response.data.data},function(response){$scope.alerts=[{msg:response.data.userMessage||"Server error! Are you connected to the internet?.",type:"error"}]})}function getHandledMessages(){$http.get("api/handled/messages/"+$scope.handleSkip).then(function(response){$scope.handledMessages=response.data.data},function(response){$scope.alerts=[{msg:response.data.userMessage||"Server error! Are you connected to the internet?.",type:"error"}]})}$scope.alerts=[],$scope.smsUnprocess=[],$scope.dataSmsCode=[],$scope.shortCodeList=[],$scope.prevCode="",$scope.skip={code:0,sms:0},$scope.remarkField={Select:null,availableOptions:["Marketing","OTP","Miscellaneous"]},$scope.length="",$scope.closeAlert=function(index){$scope.alerts.splice(index,1)},$scope.autoData=function(){""===$scope.autodata?$scope.dataSmsCode=[]:($scope.dataSmsCode=[],$http.post("api/Autocorrect/unprocessed",{text:$scope.autodata}).then(function(response){$scope.msg=response.data.userMessage,$scope.dataSmsCode=response.data.data.dataSmsCode,$scope.dataSmsText=response.data.data.dataSmsText},function(response){$scope.alerts=[{msg:response.data.userMessage||"Server error! Are you connected to the internet?.",type:"error"}]}))},$scope.nextCodePage=function(){$scope.skip.code++,loadShortCodes()},$scope.previousCodePage=function(){$scope.skip.code--,loadShortCodes()},loadShortCodes(),$scope.a=[],$scope.showbtn=function(){$scope.checkbox=!0},$scope.selectAllToBlacklist=function(){$scope.checkbox=!0,console.log($scope.bulkCode);var checkboxes=document.getElementsByName("blockme");if($scope.bulkCode)for(var j=0;j<checkboxes.length;j++)checkboxes[j].checked=!1;else for(var i=0;i<checkboxes.length;i++)checkboxes[i].checked=!0},$scope.blacklistTest=function(){for(var arr=[],checkboxes=document.getElementsByName("blockme"),i=0;i<checkboxes.length;i++)checkboxes[i].checked&&arr.push(checkboxes[i].value);console.log(arr),$http.post("api/flag/mod",{smsCode:arr}).then(function(response){$scope.smsUnprocess=[],$scope.alerts=[{msg:response.data.userMessage,type:"error"}],$scope.length=$scope.length-arr.length,angular.forEach(arr,function(value,key){var index=$scope.codeIndex(value);$scope.shortCodeList.splice(index,1)}),$scope.checkbox=!1},function(response){$scope.alerts=[{msg:response.data.userMessage||"Server error! Are you connected to the internet?.",type:"error"}]})},$scope.codeBlacklist=function(index){var code=[];code.push($scope.shortCodeList[index]),$scope.showsms=!1,$http.post("api/flag/mod",{smsCode:code}).then(function(response){$scope.smsUnprocess=[],$scope.shortCodeList.splice(index,1),$scope.alerts=[{msg:response.data.userMessage,type:"error"}],$scope.length--},function(response){$scope.alerts=[{msg:response.data.userMessage||"Server error! Are you connected to the internet?.",type:"error"}]})},$scope.codeIndex=function(code){return $scope.shortCodeList.indexOf(code)},$scope.loadsms=function(code){function call(code){$scope.smscode=code,$http.get("api/regex/"+code+"/"+$scope.skip.sms).then(function(response){0===response.data.data.length&&code===$scope.prevCode?($scope.responseMsg=code,$scope.showsms=!0,$scope.noMoreMsg="no more messages with"):0===response.data.data.length?$scope.showsms=!1:($scope.showsms=!0,$scope.smsUnprocess=response.data.data),$scope.prevCode=code},function(response){$scope.alerts=[{msg:response.data.userMessage||"Server error! Are you connected to the internet?.",type:"error"}]})}code===$scope.prevCode?call(code):($scope.skip.sms=0,call(code))},$scope.nextsmsPage=function(){$scope.skip.sms++,$scope.loadsms($scope.prevCode)},$scope.previousSmsPage=function(){$scope.skip.sms--,$scope.loadsms($scope.prevCode)},$scope.selectAll=function(){$scope.bulk?angular.forEach($scope.smsUnprocess,function(sms){sms.selected=!1}):angular.forEach($scope.smsUnprocess,function(sms){sms.selected=!0})},$scope.proceed=function(i){var sms=$scope.smsUnprocess[i];if(sms.selected){var index=$scope.smsUnprocess.indexOf(sms);$http.post("api/flag/mod",{smsCode:sms.Sender,smsText:sms.SmsText,remark:$scope.remarkField.select}).then(function(response){$scope.msg=response.data.userMessage,$scope.smsUnprocess.splice(index,1),$scope.alerts=[{msg:response.data.userMessage,type:"error"}],i<$scope.smsUnprocess.length&&$scope.proceed(i)},function(response){$scope.alerts=[{msg:response.data.userMessage||"Server error! Are you connected to the internet?.",type:"error"}]})}else i++,$scope.proceed(i);$scope.skip.sms=-1},$scope.selectMatched=function(){$scope.bulkMatch?angular.forEach($scope.dataSmsCode,function(sms){sms.select=!1}):angular.forEach($scope.dataSmsCode,function(sms){sms.select=!0})},$scope.proceedMatched=function(i){var sms=$scope.dataSmsCode[i];if(sms.select){var index=$scope.dataSmsCode.indexOf(sms);$http.post("api/flag/mod",{smsCode:sms.Sender,smsText:sms.SmsText,remark:$scope.remarkField.select}).then(function(response){$scope.msg=response.data.userMessage,$scope.dataSmsCode.splice(index,1),$scope.alerts=[{msg:response.data.userMessage,type:"error"}],i<$scope.dataSmsCode.length&&$scope.proceedMatched(i)},function(response){$scope.alerts=[{msg:response.data.userMessage||"Server error! Are you connected to the internet?.",type:"error"}]})}else i++,$scope.proceedMatched(i)},getShortcodes(),$scope.refresh=function(){$http.get("api/removeprocessedsms").then(function(response){},function(response){$scope.alerts=[{msg:response.data.userMessage||"Server error! Are you connected to the internet?.",type:"error"}]})},$scope.sort="Sender",$scope.sortBy=function(sortValue){$scope.sort=sortValue},$scope.orderBy=function(sortValue){$scope.order=sortValue},$http.get("api/unhandled/shortcodes").then(function(response){$scope.unhandledMessages=response.data.data},function(response){$scope.alerts=[{msg:response.data.userMessage||"Server error! Are you connected to the internet?.",type:"error"}]}),$scope.handleSkip=0,getHandledMessages(),$scope.nextUnhandledPage=function(){$scope.handleSkip++,getHandledMessages()},$scope.prevUnhandledPage=function(){$scope.handleSkip--,getHandledMessages()},$scope.showsms=!1,$scope.sortType="Sender",$scope.sortReverse=!1,$scope.currentPage=1,$scope.pageSize=10,$scope.reset=function(){console.log("reset"),$scope.showsms=!1,$scope.noMoreMsg=!1,$scope.smsUnprocess=[]},$scope.showhandled=!0,$scope.searchHandled=function(){$http.post("api/search/handled",{text:$scope.searchText}).then(function(response){$scope.showhandled=!1,$scope.msg=response.data.userMessage,$scope.handledMessagesMatched=response.data.data},function(response){$scope.alerts=[{msg:response.data.userMessage||"Server error! Are you connected to the internet?.",type:"error"}]})},$scope.searchunHandled=function(){$http.post("api/search/unhandled",{text:$scope.searchText}).then(function(response){$scope.showhandled=!1,$scope.msg=response.data.userMessage,$scope.unhandledMessagesMatched=response.data.data},function(response){$scope.alerts=[{msg:response.data.userMessage||"Server error! Are you connected to the internet?.",type:"error"}]})},$scope.sortType="Sender",$scope.sortReverse=!1,$scope.order=function(sortType){$scope.sortReverse=$scope.sortType===sortType?!$scope.sortReverse:!1,$scope.sortType=sortType}}]);