"use strict";angular.module("sbAdminApp",["ngAnimate","ui.bootstrap"]).controller("notificationCtrl",function($scope,$http,api,$cookieStore,DTOptionsBuilder,DTColumnBuilder,$filter,$window,$compile,$timeout){var token=$cookieStore.get("c2cCookie"),url=api.addr();$scope.closeAlert=function(argument){$scope.alert=!1},$scope.alert="",$scope.assignedTexts=[],$scope.pageno=1,$scope.total_count=0,$scope.itemsPerPage=10,$scope.currentPage=1,$scope.assignedTextsList=function(pageno){$scope.selectAll=!1,$scope.showLoadMsg=!0;var searchParams=angular.isUndefined($scope.searchStr)?"":$scope.searchStr;$scope.assignedTexts=[];var req={method:"get",url:url+"get-assigned-msgs/"+$scope.itemsPerPage+"/"+pageno,headers:{Authorization:$cookieStore.get("c2cCookie")},params:{searchParams:searchParams}};$http(req).success(function(response){$scope.assignedTexts=response.data,$scope.total_count=response.total_count,$scope.currentPage=pageno,0==$scope.total_count&&($scope.showLoadMsg=!1,$scope.showNoData=!0),$scope.assignedTexts.length>0&&($scope.showLoadMsg=!1,setTimeout(function(){$("#notification_tbl").find("td.anchor_xeditable").each(function(index){var anchor=$(this).children("a");$(anchor).click(function(){var btn=$(this).closest("td").find("button.btn-primary"),frm=$(this).closest("td").children("form");$(btn).click(function(){var selectedStatus=$(".editable-has-buttons option:selected").text(),text=$scope.assignedTexts[index]._id,req={method:"POST",url:url+"updateProcessingStatus",data:{selectedStatus:selectedStatus,text:text,token:token}};$http(req).then(function(response){response.data&&(index!==-1&&($(frm).hide(),$(anchor).removeClass("editable-hide"),$(anchor).removeClass("editable-empty"),$(anchor).text(selectedStatus)),$scope.alert="Status updated successfully.",$(".alert-success").delay(3e3).fadeOut())},function(response){console.log(response)})})})})},3e3))})},$scope.assignedTextsList($scope.pageno),$scope.sortType="saveTime",$scope.sortReverse=!1,$scope.order=function(sortType){$scope.sortReverse=$scope.sortType===sortType&&!$scope.sortReverse,$scope.sortType=sortType},$scope.statuses=[{value:"Pending",text:"Pending"},{value:"Complete",text:"Complete"},{value:"Exists",text:"Exists"}],$scope.showSelected=function(selectedStatus){$scope.selectedOption=selectedStatus},$scope.removeAssignedMessages=function(text,index){var checkstr=confirm("are you sure you want to delete this?");if(1!=checkstr)return!1;var req={method:"POST",url:url+"updateProcessingStatus",data:{selectedStatus:"Promotional",text:text,token:token}};$http(req).then(function(response){response.data&&(index!==-1&&$scope.assignedTexts.splice(index,1),$scope.alert="Deleted successfully.",$(".alert-success").delay(3e3).fadeOut())},function(response){console.log(response)})},$scope.checkAll=function(){var checkedBoolVal=document.getElementById("selectAll").checked;$("#selectAll").closest("table").find("td input:checkbox").prop("checked",checkedBoolVal)},$scope.updateMultipleSmsStatus=function(){var selectedStatus=angular.isUndefined($scope.selectedStatus)?"":$scope.selectedStatus,texts=[];if(""==selectedStatus)return void alert("Please select a status");if($.each($(".messageCheckbox:checked"),function(index,value){texts.push($(this).val())}),0==texts.length)return void alert("Please select sms");var req={method:"POST",url:url+"updateMultipleProcessingStatus",data:{selectedStatus:selectedStatus,text:texts,token:token}};$http(req).then(function(response){response.data&&($scope.alert="Status updated successfully.",$(".alert-success").delay(3e3).fadeOut(),window.location.reload())},function(response){console.log(response)})},$("#parseMsgProgressBar").hide(),$scope.parse=function(sms,index){api.post("parsemessage",!1,token,{message:sms._id,shortcode:sms.address},function(err,response){err?$scope.alert=response.message:($("#parseMsgProgressBar").hide(),1===response.count&&index!==-1&&$scope.assignedTexts.splice(index,1),$scope.alert=response.count+" message parsesd with "+response.shortcode)}),$scope.max=100,$scope.data={progress:0},function progress(){$scope.data.progress<100&&$timeout(function(){$scope.data.progress+=1,progress()},100)}(),$("#parseMsgProgressBar").show()}});