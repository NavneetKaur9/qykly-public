"use strict";angular.module("sbAdminApp").controller("shortcodesCtrl",function($scope,$http,api,$cookieStore,$window,DTOptionsBuilder,DTColumnBuilder,$filter){function decreaseCount(){for(var i=0,len=$scope.unProc.codes.length;i<len;i++)if($scope.unProc.codes[i]._id===$scope.code){$scope.unProc.codes[i].count-=$scope.msgText.length;break}}var url=api.addr(),token=$cookieStore.get("c2cCookie");$window.scrollTo(0,0),$scope.checkArray=[],$scope.check=function(value){function reset(){$scope.currentPage=1,$scope.unProc.messages=[],$scope["new"].messages=[],$scope.proc.messages=[]}var index=$scope.checkArray.indexOf(value);reset(),index===-1&&"new"===value?($scope["new"].getcodes(),$scope.checkArray.push(value)):index===-1&&"proc"===value?($scope.proc.getcodes(),$scope.checkArray.push(value)):index===-1&&"laterUse"===value&&($scope.laterUse.getcodes(),$scope.checkArray.push(value))},api.get("get-codeCount",!1,token,{},function(err,response){err||response.error?$scope.alert=response.userMessage||"Server error! Are you connected to the internet?.":$scope.count=response}),$scope.unProc={codes:[],start:0,sortby:"Time",searchCode:"",getcodes:function(){$scope.showLoader=!0,console.log("get codes00"),api.get("get-unprocessedCodes",!1,token,{start:$scope.unProc.start,search:$scope.unProc.searchCode,sortby:$scope.unProc.sortby},function(err,response){err||response.error?$scope.alert=response.userMessage||"Server error! Are you connected to the internet?.":($scope.showLoader=!1,$scope.unProc.codes=$scope.unProc.codes.concat(response))})},search:function(){$scope.unProc.codes=[],$scope.unProc.start=0,$scope.unProc.getcodes()},showMore:function(){$scope.unProc.start++,$scope.unProc.getcodes()},sort:function(){$scope.unProc.codes=[],$scope.unProc.sortby=$scope.unProc.sortby,$scope.unProc.start=0,$scope.unProc.getcodes()}},$scope.unProc.getcodes(),$scope["new"]={codes:[],start:0,sortby:"Time",searchCode:"",getcodes:function(){$scope.showLoader=!0,api.get("get-newCodes",!1,token,{start:$scope["new"].start,search:$scope["new"].searchCode,sortby:$scope["new"].sortby},function(err,response){err||response.error?$scope.alert=response.userMessage||"Server error! Are you connected to the internet?.":($scope.showLoader=!1,$scope["new"].codes=$scope["new"].codes.concat(response))})},search:function(){$scope["new"].codes=[],$scope["new"].start=0,$scope["new"].getcodes()},showMore:function(){$scope["new"].start++,$scope["new"].getcodes()},sort:function(){$scope["new"].codes=[],$scope["new"].sortby=$scope["new"].sortby,$scope["new"].start=0,$scope["new"].getcodes()}},$scope.proc={codes:[],start:0,sortby:"count",searchCode:"",getcodes:function(){$scope.showLoader=!0,api.get("get-processedCodes",!1,token,{start:$scope.proc.start,search:$scope.proc.searchCode,sortby:$scope.proc.sortby},function(err,response){err||response.error?$scope.alert=response.userMessage||"Server error! Are you connected to the internet?.":($scope.showLoader=!1,$scope.proc.codes=$scope.proc.codes.concat(response))})},search:function(){$scope.proc.codes=[],$scope.proc.start=0,$scope.proc.getcodes()},showMore:function(){$scope.proc.start++,$scope.proc.getcodes()},sort:function(){$scope.proc.codes=[],$scope.proc.sortby=$scope.proc.sortby,$scope.proc.start=0,$scope.proc.getcodes()}},$scope.laterUse={codes:[],start:0,sortby:"count",searchCode:"",getcodes:function(){$scope.showLoader=!0,api.get("get-laterUseCodes",!1,token,{start:$scope.laterUse.start,search:$scope.laterUse.searchCode,sortby:$scope.laterUse.sortby},function(err,response){err||response.error?$scope.alert=response.userMessage||"Server error! Are you connected to the internet?.":($scope.showLoader=!1,$scope.laterUse.codes=$scope.laterUse.codes.concat(response))})},search:function(){$scope.laterUse.codes=[],$scope.laterUse.start=0,$scope.laterUse.getcodes()},showMore:function(){$scope.laterUse.start++,$scope.laterUse.getcodes()},sort:function(){$scope.laterUse.codes=[],$scope.laterUse.sortby=$scope.laterUse.sortby,$scope.laterUse.start=0,$scope.laterUse.getcodes()}},$scope.start=1,$scope.currentPage=1,$scope.length=10,$scope.itemsPerPage=50,$scope.getSms=function(code,status,start,tab){code!==$scope.code&&($scope.currentPage=1),$scope.alert="loading............",$scope.loadingMsg=!0,$scope.activeMenu=code,api.get("get-messages",!1,token,{address:code,status:status,start:start,length:50},function(err,response){err||response.error?$scope.alert=response.userMessage||"Server error! Are you connected to the internet?.":($scope.code=code,$scope.start=start,$scope.status=status,$scope.tab=tab,"unProc"===tab?$scope.unProc.messages=response.data:"new"===tab?$scope["new"].messages=response.data:"proc"===tab?$scope.proc.messages=response.data:"laterUse"===tab&&($scope.laterUse.messages=response.data),$scope.totalCount=response.totalCount,$scope.loadingMsg=!1,$scope.alert=!1)})},$scope.pageChanged=function(newPage){$scope.selected_all=!1,$scope.getSms($scope.code,$scope.status,newPage,$scope.tab)},$scope.dtOptions=DTOptionsBuilder.newOptions().withOption("ajax",{url:url+"get-blacklisteds",type:"GET",data:function(aodata){"1"==aodata.draw&&(aodata.order[0].column="4",aodata.order[0].dir="desc")}}).withDataProp("data").withOption("processing",!0).withOption("serverSide",!0).withLanguage({sSearch:"Search  Blacklisted Shortcode:",oPaginate:{sNext:"»",sPrevious:"«"}}).withOption("headerCallback",function(header){$window.scrollTo(0,0)}),$scope.dtColumns=[DTColumnBuilder.newColumn("_id").notVisible().withOption("searchable",!1),DTColumnBuilder.newColumn(null).withTitle("# ").renderWith(function(data,type,full,meta){return data=meta.settings._iDisplayStart+meta.row+1}).notSortable().withOption("searchable",!1).withOption("width","2%"),DTColumnBuilder.newColumn("Sender").withTitle("Sender "),DTColumnBuilder.newColumn("Status").withTitle("Status ").withOption("searchable",!1),DTColumnBuilder.newColumn("saveTime").withTitle("DateModified      ").renderWith(function(data,type,full){return $filter("date")(data,"d/MM/yy,h:mma")}).withOption("searchable",!1).withOption("width","20%")],$scope.assign=function(){$scope.msgText=[];for(var checkboxes=document.getElementsByName("assign"),i=0;i<checkboxes.length;i++)if(checkboxes[i].checked){var value=checkboxes[i].value;$scope.msgText.push(value)}api.put("assign-msg",!1,token,{msgText:$scope.msgText,assignTo:$scope.assignTo.name},function(err,response){err||response.error?$scope.alert=response.message:($scope.alert=response.message,$scope.getSms($scope.code,$scope.status,$scope.start,$scope.tab))})},$scope.closeAlert=function(){$scope.alert=!1},$scope.searchCode="",$scope.searchShortcode=function(){api.get("Search-code",!1,token,{address:$scope.searchCode},function(err,response){$scope.alert=response.message,$scope.searchResult=response.result})},$scope.parseSms=function(code){$scope.parseSmsResult=[],$scope.alert="processing.........",api.post("parsesmsbyshortcode",!1,token,{shortcode:code},function(err,response){$scope.parseSmsResult=response,$scope.alert=!1,$scope.getShortcode("0")})},$scope.closeParseSmsResult=function(){$scope.parseSmsResult=[]},api.get("user",!1,token,!1,function(err,response){err?$scope.alert=response.message:$scope.modusers=response}),$scope.moveToDump=function(){$scope.selected_all=!1,$scope.msgText=[];for(var checkboxes=document.getElementsByName("assign"),i=0;i<checkboxes.length;i++)if(checkboxes[i].checked){var value=checkboxes[i].value;$scope.msgText.push(value)}api.put("move-to-dumb",!1,token,{msgText:$scope.msgText},function(err,response){err||response.error?$scope.alert=response.message:($scope.alert=response.message,$scope.getSms($scope.code,$scope.status,$scope.start,$scope.tab),decreaseCount())})},$scope.useLater=function(){$scope.addresses=[];for(var checkboxes=document.getElementsByName("blacklist"),i=0;i<checkboxes.length;i++)if(checkboxes[i].checked){var value=checkboxes[i].value;$scope.addresses.push(value)}api.put("later-use",!1,token,{shortcode:$scope.addresses},function(err,response){err||response.error?$scope.alerts=[{msg:response.userMessage||"Server error! Are you connected to the internet?.",type:"error"}]:($scope.alert=response.message,$scope["new"].messages=[],$scope["new"].codes=[],$scope["new"].getcodes())})},$scope.blacklist=function(){$scope.addresses=[];for(var checkboxes=document.getElementsByName("blacklist"),i=0;i<checkboxes.length;i++)if(checkboxes[i].checked){var value=checkboxes[i].value;$scope.addresses.push(value)}api.put("blacklist",!1,token,{address:$scope.addresses},function(err,response){err||response.error?$scope.alerts=[{msg:response.userMessage||"Server error! Are you connected to the internet?.",type:"error"}]:($scope.alert=response.message,$scope["new"].messages=[],$scope["new"].codes=[],$scope["new"].getcodes())})},$scope.moveAllToDump=function(){1==confirm("Are you sure you want to move all the messages of "+$scope.code+" to Dump!!!")&&api.put("move-all-to-dump",!1,token,{address:$scope.code},function(err,response){err||response.error?$scope.alerts=[{msg:response.userMessage||"Server error! Are you connected to the internet?.",type:"error"}]:($scope.alert=response.message,$scope.unProc.messages=[],$scope.unProc.codes=[],$scope.unProc.getcodes())})}});